name: JMeter Test Suite

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  jmeter-test:
    runs-on: ubuntu-latest

    steps:
    # --- SETUP ---
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Java 17
      uses: actions/setup-java@v3
      with:
        distribution: 'temurin'
        java-version: '17'

    # --- JMETER INSTALLATION ---
    - name: Download JMeter
      id: download-jmeter
      run: |
        JMETER_VERSION="5.6.2"
        JMETER_DIR="apache-jmeter-${JMETER_VERSION}"
        
        # Download and extract
        wget -q https://archive.apache.org/dist/jmeter/binaries/apache-jmeter-${JMETER_VERSION}.tgz
        tar -xzf apache-jmeter-${JMETER_VERSION}.tgz
        
        # Set absolute path
        JMETER_PATH="$GITHUB_WORKSPACE/${JMETER_DIR}"
        echo "JMETER_HOME=${JMETER_PATH}" >> $GITHUB_ENV
        echo "PATH=${JMETER_PATH}/bin:$PATH" >> $GITHUB_ENV
        
        # Verify extraction
        echo "JMeter extracted to: ${JMETER_PATH}"
        ls -la ${JMETER_PATH}/bin/jmeter

    # --- VERIFICATION ---
    - name: Verify installation
      run: |
        echo "Current directory: $(pwd)"
        echo "JMETER_HOME: $JMETER_HOME"
        echo "PATH: $PATH"
        
        # Full validation
        ls -la $JMETER_HOME/bin/
        $JMETER_HOME/bin/jmeter --version
        echo "JMeter verification successful"

    # --- TEST EXECUTION ---
    - name: Run JMeter test
      run: |
        mkdir -p ./jmeter-results
        echo "Running test from: $(pwd)"
        echo "Using JMeter at: $JMETER_HOME/bin/jmeter"
        
        $JMETER_HOME/bin/jmeter -n -t ./jmeter/test.jmx \
          -l ./jmeter-results/results.jtl \
          -e -o ./jmeter-results/html-report

    # --- ARTIFACT HANDLING ---
    - name: Package results
      run: |
        cd jmeter-results
        zip -r report.zip html-report/ || echo "No HTML report to package"

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: jmeter-results
        path: |
          jmeter-results/results.jtl
          jmeter-results/report.zip
        if-no-files-found: warn
