name: JMeter Test Suite

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  jmeter-test:
    runs-on: ubuntu-latest

    steps:
    # --- SETUP ---
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Java 17
      uses: actions/setup-java@v3
      with:
        distribution: 'temurin'
        java-version: '17'

    # --- JMETER INSTALLATION ---
    - name: Setup JMeter
      run: |
        JMETER_VERSION="5.6.2"
        JMETER_DIR="apache-jmeter-${JMETER_VERSION}"
        rm -rf ${JMETER_DIR} apache-jmeter-*.tgz
        wget -q https://archive.apache.org/dist/jmeter/binaries/apache-jmeter-${JMETER_VERSION}.tgz
        tar -xzf apache-jmeter-${JMETER_VERSION}.tgz
        echo "JMETER_HOME=${GITHUB_WORKSPACE}/${JMETER_DIR}" >> $GITHUB_ENV

    # --- CLEAN & PREPARE ---
    - name: Prepare output directory
      run: |
        rm -rf ./jmeter-results
        mkdir -p ./jmeter-results/{html,csv,json,xml,junit}
        echo "Created output directories"

    # --- TEST EXECUTION ---
    - name: Run JMeter with multiple reporters
      run: |
        $JMETER_HOME/bin/jmeter -n -t ./jmeter/test.jmx \
          -l ./jmeter-results/results.jtl \          # Default JTL format
          -e -o ./jmeter-results/html \              # HTML dashboard
          -Jjmeter.save.saveservice.output_format=xml \  # XML format
          -Jjmeter.save.saveservice.print_field_names=true

        # Generate CSV report from JTL
        $JMETER_HOME/bin/JMeterPluginsCMD.sh \
          --tool Reporter \
          --input-jtl ./jmeter-results/results.jtl \
          --plugin-type AggregateReport \
          --generate-csv ./jmeter-results/csv/aggregate.csv

        # Generate JSON report
        $JMETER_HOME/bin/JMeterPluginsCMD.sh \
          --tool Reporter \
          --input-jtl ./jmeter-results/results.jtl \
          --plugin-type AggregateReport \
          --generate-json ./jmeter-results/json/aggregate.json

        # Generate JUnit-style XML
        $JMETER_HOME/bin/JMeterPluginsCMD.sh \
          --tool Reporter \
          --input-jtl ./jmeter-results/results.jtl \
          --plugin-type JMeterPluginsCMD.JUnitReporter \
          --generate-xml ./jmeter-results/junit/results.xml

    # --- VALIDATION ---
    - name: Verify reports
      run: |
        echo "Generated reports:"
        find ./jmeter-results -type f
        
        # Check each report type
        for fmt in jtl csv json xml html junit; do
          count=$(find ./jmeter-results/$fmt -type f | wc -l)
          [ $count -eq 0 ] && echo "::warning::No $fmt reports generated"
        done

    # --- ARTIFACT UPLOAD ---
    - name: Upload all reports
      uses: actions/upload-artifact@v4
      with:
        name: jmeter-reports-${{ github.run_number }}
        path: |
          jmeter-results/results.jtl
          jmeter-results/html/**
          jmeter-results/csv/**
          jmeter-results/json/**
          jmeter-results/xml/**
          jmeter-results/junit/**
        if-no-files-found: warn
