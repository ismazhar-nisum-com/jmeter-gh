name: JMeter Test Suite

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  jmeter-test:
    runs-on: ubuntu-latest

    steps:
    # --- SETUP ---
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Java 17
      uses: actions/setup-java@v3
      with:
        distribution: 'temurin'
        java-version: '17'

    # --- JMETER INSTALLATION (WITH CACHING) ---
    - name: Cache JMeter
      id: cache-jmeter
      uses: actions/cache@v3
      with:
        path: apache-jmeter-5.6.2
        key: ${{ runner.os }}-jmeter-5.6.2

    - name: Install JMeter (if not cached)
      if: steps.cache-jmeter.outputs.cache-hit != 'true'
      run: |
        echo "Installing JMeter..."
        wget -q https://archive.apache.org/dist/jmeter/binaries/apache-jmeter-5.6.2.tgz
        tar -xzf apache-jmeter-5.6.2.tgz
        echo "JMETER_HOME=$PWD/apache-jmeter-5.6.2" >> $GITHUB_ENV
        echo "PATH=$PWD/apache-jmeter-5.6.2/bin:$PATH" >> $GITHUB_ENV

    # --- DEBUG: VERIFY INSTALLATION ---
    - name: Verify JMeter installation
      run: |
        echo "JMETER_HOME: $JMETER_HOME"
        echo "PATH: $PATH"
        ls -la $JMETER_HOME/bin/
        $JMETER_HOME/bin/jmeter --version

    # --- TEST EXECUTION ---
    - name: Run JMeter test
      id: jmeter-run
      run: |
        # Create output directories
        mkdir -p ./jmeter-results/html-report
        
        echo "Running JMeter test..."
        $JMETER_HOME/bin/jmeter -n -t ./jmeter/test.jmx \
          -l ./jmeter-results/results.jtl \
          -e -o ./jmeter-results/html-report

        # Debug: Show first 5 lines of JTL
        echo "JTL file preview:"
        head -n 5 ./jmeter-results/results.jtl || echo "No JTL file generated"

    # --- ARTIFACT HANDLING ---
    - name: Compress and upload results
      if: always()
      run: |
        # Zip HTML report if exists
        if [ -d "jmeter-results/html-report" ]; then
          cd jmeter-results
          zip -r report.zip html-report/
        fi

        # Upload artifacts
        echo "Contents of jmeter-results:"
        ls -la jmeter-results/
      uses: actions/upload-artifact@v4
      with:
        name: jmeter-results
        path: |
          jmeter-results/results.jtl
          jmeter-results/report.zip
        if-no-files-found: warn
